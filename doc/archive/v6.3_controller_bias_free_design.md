# v6.3: Controller-Bias-Free Data Collection

**Version**: v6.3
**Date**: 2026-01-13
**Status**: Implementation Complete, Ready for Data Collection

---

## üéØ **Motivation: Addressing Controller Bias**

### The Problem (v6.2)

In v6.2, training data was collected using the **FEP-based controller** (`compute_action_v61`):

```julia
# v6.2: BIASED data collection
u = compute_action_v61(agent, spm, other_agents, ...)  # Uses FEP optimization
```

**Critical Issue**: This introduces **circular dependency**:
1. VAE learns from FEP controller's behavioral patterns
2. VAE is used to improve FEP controller
3. ‚Üí **"The VAE learns what FEP already knows"**

**Reviewer Concern**:
> "How can you claim unbiased VAE learning when training data was generated by the FEP controller itself?"

---

### The Solution (v6.3)

v6.3 uses **controller-agnostic** random walk with **geometric collision avoidance**:

```julia
# v6.3: UNBIASED data collection
u = compute_action_random_collision_free(
    agent, other_agents, obstacles, ...
)
```

**Method**:
1. **Random walk** with goal bias (no optimization)
2. **Geometric repulsive forces** (inverse square law)
3. **Hard collision avoidance** (distance > safety_threshold)

**Result**: Diverse state-action coverage **without controller assumptions**.

---

## üìä **v6.2 vs v6.3 Comparison**

| Aspect | v6.2 (FEP-Biased) | v6.3 (Controller-Bias-Free) |
|--------|-------------------|----------------------------|
| **Controller** | FEP free energy minimization | Random walk + repulsion |
| **Optimization** | Gradient descent on F(u) | No optimization |
| **Collision Rate** | ~12.5% (crowded scenarios) | Target: <0.1% |
| **Behavioral Bias** | ‚ö†Ô∏è FEP patterns | ‚úÖ Unbiased exploration |
| **Data Diversity** | Moderate (converges to FEP) | High (random exploration) |
| **Computational Cost** | High (gradient computation) | Low (geometric forces) |
| **Academic Rigor** | ‚ö†Ô∏è Circular dependency | ‚úÖ Unbiased learning |
| **Log Data** | Basic (pos, vel, u, heading) | Extended (+goal, d_pref, group, collision flags) |

---

## üßÆ **Algorithm: Random Walk + Collision Avoidance**

### Step 1: Goal-Directed Random Walk

```julia
d_pref = normalize(agent.goal - agent.pos)
u_random = d_pref + randn(2) * exploration_noise
```

- **Goal bias**: Tends toward goal position
- **Random perturbation**: Exploration noise (œÉ=0.5)

### Step 2: Agent Repulsion (Inverse Square Law)

```julia
for other in other_agents
    rel_pos = agent.pos - other.pos
    dist = norm(rel_pos)

    if dist < safety_threshold
        direction = rel_pos / dist
        repulsion = repulsion_strength / (dist^2 + 0.1)
        u_random += direction * repulsion
    end
end
```

- **Safety threshold**: 3.0m (tunable)
- **Repulsion strength**: 1.0 (tunable)
- **Inverse square**: Stronger repulsion at closer distances

### Step 3: Obstacle Repulsion (Stronger)

```julia
for obs in obstacles
    # 2x stronger repulsion for static obstacles
    repulsion = 2.0 * repulsion_strength / (dist^2 + 0.1)
    u_random += direction * repulsion
end
```

### Step 4: Convert to [v, œâ] Control

```julia
# Normalize and scale
v_desired = min(1.0, norm(u_random)) * u_max

# Angular velocity (align heading with desired direction)
heading_error = desired_heading - current_heading
œâ = 2.0 * heading_error  # P controller

return [v, œâ]
```

---

## üìÇ **Extended HDF5 Data Structure**

### NEW in v6.3

```
trajectory/
  pos: [2, N, T]          ‚úÖ Same as v6.2
  vel: [2, N, T]          ‚úÖ Same as v6.2
  u: [2, N, T]            ‚úÖ Same as v6.2
  heading: [N, T]         ‚úÖ Same as v6.2
  goal: [2, N]            üÜï Goal positions per agent
  d_pref: [2, N, T]       üÜï Preferred direction at each step
  group: [N]              üÜï Agent group (0=WEST, 1=NORTH, ...)

events/
  collision: [N, T]       üÜï Binary collision flag (1=collision detected)
  near_collision: [N, T]  üÜï Near-collision flag (dist < safety_threshold)

metadata/
  controller_type: str    üÜï "RandomWalk_CollisionFree_v63"
  safety_threshold: float üÜï 3.0m
  repulsion_strength: float üÜï 1.0
  ...                     ‚úÖ Same as v6.2
```

**Why Extended Logs?**
- `goal`, `d_pref`: Enable goal-conditioned learning
- `group`: Enable group-aware models
- `collision`, `near_collision`: Training data filtering, ablation studies

---

## üöÄ **Usage**

### Basic Usage (Dry Run)

```bash
# Test with 100 steps, single condition
julia --project=. scripts/create_dataset_v63_random_collision_free.jl \
  --scenario scramble \
  --densities 5 \
  --seeds 1 \
  --dry-run
```

**Expected Output**:
```
Collision rate: ~1-2% (100 steps, statistically unstable)
Near-collision rate: ~60% (agents appropriately approaching)
```

### Full Data Collection (80 files)

```bash
# Same as v6.2: 2 scenarios √ó 4 densities √ó 5 seeds √ó 2 widths = 80 files
julia --project=. scripts/create_dataset_v63_random_collision_free.jl \
  --scenario both \
  --densities 5,10,15,20 \
  --seeds 1:5 \
  --corridor-widths 30,40,50
```

**Estimated Time**: ~3 hours (80 simulations √ó ~135s)

### Parameter Tuning (Reduce Collision Rate)

If collision rate > 0.1%, adjust parameters:

```bash
# Increase safety threshold
julia --project=. scripts/create_dataset_v63_random_collision_free.jl \
  --safety-threshold 4.0 \  # Default: 3.0m
  --repulsion-strength 1.5 \ # Default: 1.0
  --dry-run
```

**Trade-off**: Higher safety ‚Üí Lower collision rate BUT more freezing/deadlocks

---

## üß™ **Validation Protocol**

### 1. Collision Rate Check

```bash
# After data collection, verify collision rates
python scripts/validate_collision_rates_v63.py data/vae_training/raw_v63/
```

**Acceptance Criteria**:
- Average collision rate < 0.1%
- No individual file > 0.5%

### 2. Data Diversity Check

```bash
# Compare action distributions: v6.2 vs v6.3
python scripts/compare_action_distributions.py \
  data/vae_training/raw_v62/ \
  data/vae_training/raw_v63/
```

**Expected**:
- v6.3 has **higher entropy** in action distribution
- v6.3 has **wider coverage** of (spm, action) space

### 3. HDF5 Structure Verification

```bash
# Verify extended logs are present
python scripts/verify_v63_structure.py data/vae_training/raw_v63/v63_scramble_d5_s1_*.h5
```

**Check**:
- `trajectory/goal` exists and has shape [2, N]
- `events/collision` exists
- `metadata/controller_type == "RandomWalk_CollisionFree_v63"`

---

## üìà **Next Steps: VAE Training with v6.3 Data**

### 1. Trajectory Loader (v6.3)

Create `scripts/trajectory_loader_v63.jl` to handle extended logs:

```julia
# Load extended trajectory data
function load_trajectory_v63(h5_file)
    pos, vel, u, heading = load_basic_trajectory(h5_file)  # Same as v6.2

    # NEW: Load extended data
    goal = h5read(h5_file, "trajectory/goal")
    d_pref = h5read(h5_file, "trajectory/d_pref")
    group = h5read(h5_file, "trajectory/group")
    collision = h5read(h5_file, "events/collision")

    return (pos, vel, u, heading, goal, d_pref, group, collision)
end
```

### 2. VAE Training Script (v6.3)

Create `scripts/train_action_vae_v63.jl`:

```julia
# Filter collision-free samples only
collision_free_mask = .!(collision_flags)
train_data = (
    spm_current = spm_current[collision_free_mask, :, :, :],
    actions = actions[collision_free_mask, :],
    spm_next = spm_next[collision_free_mask, :, :, :]
)
```

### 3. Ablation Study: v6.2 vs v6.3

Train VAE on both datasets and compare:

| Metric | v6.2 (FEP-biased) | v6.3 (Unbiased) |
|--------|-------------------|-----------------|
| Reconstruction MSE | ? | ? |
| KL divergence | ? | ? |
| Haze correlation with risk | ? | ? |
| Freezing rate (inference) | ? | ? |
| Collision rate (inference) | ? | ? |

**Hypothesis**: v6.3 will show:
- Higher reconstruction MSE (more diverse data)
- Better generalization (unbiased learning)
- Lower collision rate (cleaner training data)

---

## üõ°Ô∏è **Academic Justification**

### For Reviewers

**Reviewer Question**:
> "Your VAE training data was generated by the FEP controller itself. How is this not circular?"

**Our Answer (v6.3)**:
> "We acknowledge this limitation in v6.2. To address it, we collected v6.3 data using
> controller-agnostic random walk with geometric collision avoidance. This ensures the
> VAE learns environment dynamics, not controller biases. We provide ablation studies
> comparing v6.2 (FEP-biased) vs v6.3 (unbiased) to demonstrate the impact."

### For Paper

**Section 4.2: Training Data Collection**

```markdown
We collected two datasets:

**Dataset v6.2 (FEP-biased)**: Generated using our FEP-based controller. This
reflects a realistic scenario where the robot learns from its own experience.
However, it introduces controller bias.

**Dataset v6.3 (Controller-bias-free)**: Generated using random walk with geometric
collision avoidance (inverse square repulsion). This ensures unbiased state-action
coverage without controller assumptions.

We train VAE models on both datasets and compare performance (Section 5.3: Ablation Study).
```

---

## üîß **Troubleshooting**

### Issue: Collision Rate > 0.1%

**Causes**:
1. Safety threshold too small (3.0m)
2. Repulsion strength too weak (1.0)
3. High-density scenarios (20 agents/group)

**Solutions**:
```bash
# Option 1: Increase safety threshold
--safety-threshold 4.0

# Option 2: Increase repulsion strength
--repulsion-strength 1.5

# Option 3: Filter high-collision files post-hoc
python scripts/filter_high_collision_files.py data/vae_training/raw_v63/
```

### Issue: Agents Freeze/Deadlock

**Cause**: Repulsion too strong, agents repel each other into standstill

**Solution**: Decrease repulsion strength or add random perturbation
```bash
--repulsion-strength 0.8
--exploration-noise 0.7  # Increase from 0.5
```

### Issue: HDF5 Dimension Mismatch

**Symptom**: `shape mismatch: expected [2, N, T], got [T, N, 2]`

**Cause**: `permutedims` order incorrect

**Solution**: Already fixed in script (line 344-351)

---

## üìù **Implementation Checklist**

- [x] v6.3 controller function (`compute_action_random_collision_free`)
- [x] v6.3 data collection script (`create_dataset_v63_random_collision_free.jl`)
- [x] Extended HDF5 logs (goal, d_pref, group, collision flags)
- [x] Dry run test (100 steps, single condition)
- [ ] Full data collection (80 files, 3 hours)
- [ ] Collision rate validation
- [ ] v6.3 trajectory loader
- [ ] v6.3 VAE training script
- [ ] Ablation study: v6.2 vs v6.3
- [ ] Documentation in paper

---

## üìö **References**

### Geometric Collision Avoidance
- **Helbing et al. (1995)**: Social Force Model for pedestrian dynamics
- **Fox et al. (1997)**: Dynamic Window Approach (DWA) for mobile robots
- **van den Berg et al. (2008)**: Reciprocal Velocity Obstacles (RVO)

### Controller-Free Learning
- **Pathak et al. (2017)**: Curiosity-driven exploration without rewards
- **Eysenbach et al. (2018)**: Diversity is All You Need (DIAYN)
- **Sekar et al. (2020)**: Planning to Explore via Self-Supervised World Models

---

**v6.3 Status**: ‚úÖ Implementation Complete
**Next Milestone**: Full data collection (80 files)
**Expected Completion**: 2026-01-13 (evening)
